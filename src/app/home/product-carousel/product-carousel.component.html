<div class="carousel-container">
  <div *ngIf="isLoading" class="loading-shell" aria-busy="true">
    <div class="section-header">
      <div class="section-meta">
        <span class="eyebrow">Colección Seleccionada</span>
        <h2>Productos destacados</h2>
        <p>Estamos cargando la selección del día.</p>
      </div>
    </div>
    <div class="products-gallery">
      <div class="gallery-grid">
        <article class="product-card skeleton" *ngFor="let i of skeletonCards">
          <div class="product-image-container"></div>
          <div class="product-content">
            <div class="skeleton-chip"></div>
            <div class="skeleton-title"></div>
            <div class="skeleton-lines">
              <span></span>
              <span></span>
            </div>
            <div class="skeleton-footer">
              <span></span>
              <span></span>
            </div>
          </div>
        </article>
      </div>
    </div>
  </div>

  <div *ngIf="!isLoading && error" class="state-card error">
    <i class="fas fa-exclamation-circle"></i>
    <span>{{ error }}</span>
  </div>

  <ng-container *ngIf="!isLoading && !error && products.length > 0">
    <div class="section-header">
      <div class="section-meta">
        <span class="eyebrow">Colección Seleccionada</span>
        <h2>Productos destacados</h2>
        <p>Curaduría con stock y compra rápida para que elijas sin vueltas.</p>
      </div>
    </div>

    <div class="products-gallery">
      <div class="gallery-grid">
        <article
          class="mosaic-card"
          *ngFor="let product of visibleProducts; trackBy: trackByProductId">
          <a
            class="mosaic-surface"
            [routerLink]="['/productos', product.id]"
            [attr.aria-label]="'Ver producto ' + product.name">
            <div class="mosaic-bg">
              <img
                [src]="product.image"
                [alt]="product.name"
                loading="lazy">
            </div>

            <div class="mosaic-overlay"></div>

            <header class="mosaic-header">
              <span class="mosaic-chip">{{ product.category || 'Colección Mate' }}</span>
              <span class="mosaic-count" *ngIf="product.stock !== undefined">
                <i class="fas" [ngClass]="getStockBadgeIcon(product)"></i>
                {{ getStockBadgeLabel(product) }}
              </span>
            </header>

            <div class="mosaic-body">
              <h3 class="mosaic-title">{{ product.name }}</h3>
              <p class="mosaic-description">{{ product.description }}</p>

              <div class="mosaic-featured" *ngIf="product.price">
                <div class="featured-left">
                  <span class="featured-tag" *ngIf="product.discount">Ahorro -{{ product.discount }}%</span>
                  <span class="featured-tag" *ngIf="!product.discount">Precio</span>
                  <span class="featured-name">{{ getDisplayPrice(product) | currency:'ARS':'symbol-narrow' }}</span>
                  <span class="featured-price" *ngIf="product.discount">{{ product.price | currency:'ARS':'symbol-narrow' }}</span>
                </div>
                <div class="featured-thumb">
                  <img [src]="product.image" [alt]="product.name" loading="lazy">
                </div>
              </div>

              <div class="mosaic-pills">
                <span class="pill" *ngIf="product.seasonal">Destacado</span>
                <span class="pill" *ngIf="product.discount">-{{ product.discount }}%</span>
                <span class="pill" *ngIf="product.rating">★ {{ getRating(product) }}</span>
              </div>
            </div>

            <footer class="mosaic-footer">
              <div class="mosaic-footer-row">
                <span class="mosaic-link">
                  Ver producto
                  <i class="fas fa-arrow-right"></i>
                </span>

                <button
                  class="mosaic-cart"
                  type="button"
                  [disabled]="product.stock <= 0"
                  (click)="$event.preventDefault(); $event.stopPropagation(); addToCart(product)">
                  <i class="fas fa-cart-plus"></i>
                  <span>{{ product.stock > 0 ? 'Agregar' : 'Sin stock' }}</span>
                </button>
              </div>
            </footer>
          </a>
        </article>
      </div>
    </div>

    <div class="gallery-controls">
      <button class="control-button prev" 
              (click)="prevGroup(); $event.stopPropagation()" 
              [disabled]="currentGroup === 0"
              aria-label="Anterior">
        <i class="fas fa-chevron-left"></i>
      </button>
      <div class="gallery-indicators">
        <span *ngFor="let group of totalGroups; let i = index" 
              class="indicator" 
              [class.active]="i === currentGroup"
              (click)="showGroup(i); $event.stopPropagation()">
        </span>
      </div>
      <button class="control-button next" 
              (click)="nextGroup(); $event.stopPropagation()"
              [disabled]="currentGroup === totalGroups.length - 1"
              aria-label="Siguiente">
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </ng-container>

  <div *ngIf="!isLoading && !error && products.length === 0" class="empty-state">
    <i class="fas fa-box-open"></i>
    <div>
      <h3>Sin productos destacados por ahora</h3>
      <p>Volvé en unos minutos o explorá el catálogo completo.</p>
      <a routerLink="/productos" class="empty-cta">Ver catálogo</a>
    </div>
  </div>
</div>