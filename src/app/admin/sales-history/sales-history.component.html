<div class="sales-history-container">
  <div class="history-header">
    <h2>Historial Completo de Ventas</h2>
    <div class="header-actions">
      <a routerLink="/ventas" class="btn-back">
        <i class="fas fa-arrow-left"></i> Volver a Ventas
      </a>
      <button class="btn-export" (click)="exportToExcel()">
        <i class="fas fa-file-excel"></i> Exportar a Excel
      </button>
    </div>
  </div>

  <div *ngIf="loading" class="loading">
    <i class="fas fa-spinner fa-spin"></i> Cargando historial...
  </div>

  <div *ngIf="errorMessage" class="error-message">
    {{ errorMessage }}
  </div>

  <div class="empty-state" *ngIf="!loading && historyRows.length === 0 && !errorMessage">
    <i class="fas fa-clipboard-list"></i>
    <p>No encontramos ventas registradas todavía.</p>
    <small>Cuando registres operaciones aparecerán en este historial.</small>
  </div>

  <div class="table-container" *ngIf="!loading && historyRows.length > 0">
    <table class="sales-table">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Estado</th>
          <th>Métodos de Pago</th>
          <th>Productos</th>
          <th>Total</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of historyRows; trackBy: trackBySaleId" [class.cancelled]="row.sale.status === 'cancelled'">
          <td>{{ row.sale.created_at | date:'medium' }}</td>
          <td>
            <span class="status-badge" [class]="row.sale.status">
              {{ row.sale.status === 'completed' ? 'Completada' : 'Cancelada' }}
            </span>
          </td>
          <td>
            <div class="payment-methods-list">
              <span *ngFor="let method of row.paymentSummaries">
                {{ method.name }}
                <span *ngIf="method.amount" class="payment-amount">({{ method.amount | currency:'USD' }})</span>
              </span>
            </div>
          </td>
          <td>
            <ul class="products-list">
              <li *ngFor="let item of row.items">
                {{ item.product_name }} 
                <span class="product-details">
                  ({{ item.quantity }}x {{ item.unit_price | currency:'USD' }})
                </span>
              </li>
            </ul>
          </td>
          <td class="total-column">{{ row.sale.total_amount | currency:'USD' }}</td>
          <td>
            <button 
              *ngIf="row.sale.status === 'completed'"
              (click)="cancelSale(row.sale.id)" 
              class="btn-cancel" 
              title="Cancelar venta">
              <i class="fas fa-ban"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
    <div class="pagination-controls" *ngIf="sales.length < totalSales">
      <button (click)="loadMore()" [disabled]="isLoadingMore" class="btn-load-more">
        <i class="fas fa-spinner fa-spin" *ngIf="isLoadingMore"></i>
        Cargar más
      </button>
      <span class="pagination-info">
        Mostrando {{ sales.length }} de {{ totalSales }} ventas
      </span>
    </div>
  </div>
</div>