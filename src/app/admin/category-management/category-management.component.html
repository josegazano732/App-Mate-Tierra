<section class="categories-page">
  <header class="page-hero">
    <div>
      <p class="eyebrow">Catálogo</p>
      <h2>Gestión de categorías</h2>
      <p>Mantené tu tienda ordenada creando, editando o archivando categorías que sí existan en el backend.</p>
    </div>
    <div class="hero-meta">
      <span class="status-pill" [class.success]="!isLoading">
        <i class="fas" [class.fa-circle-notch]="isLoading" [class.fa-check-circle]="!isLoading"></i>
        {{ isLoading ? 'Sincronizando' : 'Sincronizado' }}
      </span>
      <button type="button" class="ghost-button" (click)="loadCategories()">
        <i class="fas fa-rotate"></i>
        Refrescar
      </button>
    </div>
  </header>

  <section class="stats-grid">
    <article class="stat-card">
      <p>Total de categorías</p>
      <h3>{{ stats.totalCategories }}</h3>
      <small>{{ filteredCategories.length }} visibles</small>
    </article>
    <article class="stat-card">
      <p>Productos asociados</p>
      <h3>{{ stats.totalProducts }}</h3>
      <small>Datos proporcionados por el backend</small>
    </article>
    <article class="stat-card secondary">
      <p>Filtro activo</p>
      <h3>{{ searchTerm ? 'Personalizado' : 'Todos' }}</h3>
      <small>{{ searchTerm || 'Sin filtros aplicados' }}</small>
    </article>
  </section>

  <section class="management-grid">
    <article class="panel add-panel">
      <div class="panel-header">
        <div>
          <h3>Nueva categoría</h3>
          <p>Los campos obligatorios coinciden con lo disponible en el backend: nombre, imagen y descripción.</p>
        </div>
      </div>
      <form (ngSubmit)="onSubmit()" class="category-form">
        <label class="form-field">
          <span>Nombre</span>
          <input type="text" [(ngModel)]="newCategory.name" name="name" placeholder="Ej: Kits de mate" required />
        </label>
        <label class="form-field">
          <span>Descripción</span>
          <textarea [(ngModel)]="newCategory.description" name="description" rows="3" placeholder="Breve texto que se verá en la web"></textarea>
        </label>
        <label class="form-field">
          <span>URL de imagen</span>
          <input type="url" [(ngModel)]="newCategory.image" name="image" placeholder="https://" required />
        </label>
        <div class="form-field image-picker" *ngIf="productImageOptions.length">
          <span>Elegir desde productos</span>
          <select
            [(ngModel)]="selectedNewImageOption"
            name="new-image-picker"
            (change)="onImageSelectFromPicker(selectedNewImageOption, 'new')"
          >
            <option value="">Seleccioná una imagen disponible</option>
            <option *ngFor="let option of productImageOptions" [value]="option.url">
              {{ option.label }}
            </option>
          </select>
          <small>Completamos automáticamente el campo con la URL seleccionada.</small>
        </div>
        <div class="form-meta">
          <span class="slug">Slug: {{ newCategory.name ? generateSlug(newCategory.name) : 'pendiente' }}</span>
          <span class="preview-label">Vista previa</span>
        </div>
        <div class="preview-box">
          <img [src]="getImagePreview(newCategory)" alt="Vista previa" />
        </div>
        <button type="submit" class="btn-primary" [disabled]="isLoading">
          <i class="fas fa-plus"></i>
          Guardar categoría
        </button>
        <div *ngIf="errorMessage" class="error-inline">
          <i class="fas fa-exclamation-triangle"></i>
          {{ errorMessage }}
        </div>
      </form>
    </article>

    <article class="panel list-panel">
      <div class="panel-header">
        <div>
          <h3>Categorías activas</h3>
          <p>Todo lo que ves acá proviene del backend mockeado. Eliminá lo que no uses.</p>
        </div>
        <div class="toolbar">
          <div class="search-field">
            <i class="fas fa-search"></i>
            <input type="text" [value]="searchTerm" (input)="onSearchChange($any($event.target).value)" placeholder="Buscar por nombre o descripción" />
          </div>
        </div>
      </div>

      <div *ngIf="isLoading" class="loading">
        <i class="fas fa-spinner fa-spin"></i>
        Consultando categorías...
      </div>

      <div *ngIf="!isLoading && filteredCategories.length" class="categories-grid">
        <article class="category-card" *ngFor="let category of filteredCategories; trackBy: trackByCategoryId">
          <figure>
            <img [src]="getImagePreview(category)" [alt]="category.name" />
          </figure>
          <div class="card-body">
            <header>
              <h4>{{ category.name }}</h4>
              <span class="badge">{{ category.productCount || 0 }} productos</span>
            </header>
            <p class="description">{{ category.description || 'Sin descripción definida.' }}</p>
            <span class="slug">/{{ category.slug }}</span>
          </div>
          <footer class="card-actions">
            <button type="button" class="ghost-button" (click)="editCategory(category)">
              <i class="fas fa-pen"></i> Editar
            </button>
            <button type="button" class="ghost-button danger" (click)="deleteCategory(category.id)">
              <i class="fas fa-trash"></i> Eliminar
            </button>
          </footer>
        </article>
      </div>

      <div *ngIf="!isLoading && !filteredCategories.length" class="empty-state">
        <i class="fas fa-inbox"></i>
        <p>No encontramos categorías con ese filtro.</p>
        <small>Probá limpiar la búsqueda o creá una nueva categoría.</small>
      </div>
    </article>
  </section>

  <div *ngIf="editingCategory" class="modal">
    <div class="modal-content">
      <header>
        <h3>Editar categoría</h3>
        <button type="button" class="ghost-button" (click)="editingCategory = null">
          <i class="fas fa-times"></i>
        </button>
      </header>
      <form (ngSubmit)="updateCategory()" class="modal-form">
        <label class="form-field">
          <span>Nombre</span>
          <input type="text" [(ngModel)]="editingCategory.name" name="edit-name" required />
        </label>
        <label class="form-field">
          <span>Descripción</span>
          <textarea [(ngModel)]="editingCategory.description" name="edit-description" rows="3"></textarea>
        </label>
        <label class="form-field">
          <span>URL de imagen</span>
          <input type="url" [(ngModel)]="editingCategory.image" name="edit-image" required />
        </label>
        <div class="form-field image-picker" *ngIf="productImageOptions.length">
          <span>Elegir desde productos</span>
          <select
            [(ngModel)]="selectedEditImageOption"
            name="edit-image-picker"
            (change)="onImageSelectFromPicker(selectedEditImageOption, 'edit')"
          >
            <option value="">Seleccioná una imagen disponible</option>
            <option *ngFor="let option of productImageOptions" [value]="option.url">
              {{ option.label }}
            </option>
          </select>
          <small>La URL se completará con la imagen elegida.</small>
        </div>
        <div class="form-meta">
          <span class="slug">Slug: {{ generateSlug(editingCategory.name) }}</span>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn-primary" [disabled]="isLoading">
            <i class="fas fa-save"></i> Guardar cambios
          </button>
          <button type="button" class="ghost-button" (click)="editingCategory = null">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>
</section>