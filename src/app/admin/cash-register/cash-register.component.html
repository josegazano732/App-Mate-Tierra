<div class="cash-register-container">
  <div class="history-header">
    <h2>Reporte de Caja</h2>
    <div class="header-actions">
      <button class="btn-export" (click)="exportToExcel()">
        <i class="fas fa-file-excel"></i> Exportar a Excel
      </button>
      <button class="btn-withdrawal" (click)="showWithdrawalForm = true">
        <i class="fas fa-money-bill-wave-alt"></i> Registrar Retiro
      </button>
      <button class="btn-income" (click)="showIncomeForm = true">
        <i class="fas fa-money-bill-wave"></i> Registrar Ingreso
      </button>
    </div>
  </div>

  <div *ngIf="isLoading" class="loading">
    <i class="fas fa-spinner fa-spin"></i> Cargando datos...
  </div>

  <div *ngIf="errorMessage" class="error-message">
    {{ errorMessage }}
  </div>

  <div *ngIf="!isLoading && !errorMessage" class="report-content">
    <!-- Summary Cards -->
    <div class="summary-cards">
      <div class="summary-card total-sales">
        <div class="card-icon">
          <i class="fas fa-cash-register"></i>
        </div>
        <div class="card-content">
          <h3>Total de Ventas</h3>
          <p class="amount">{{ totalAmount | currency:'USD' }}</p>
          <p class="detail">{{ totalSales }} transacciones</p>
        </div>
      </div>
      <div class="summary-card total-incomes">
        <div class="card-icon">
          <i class="fas fa-arrow-trend-up"></i>
        </div>
        <div class="card-content">
          <h3>Ingresos de Caja</h3>
          <p class="amount">{{ totalIncomes | currency:'USD' }}</p>
          <p class="detail">{{ incomes.length }} registros</p>
        </div>
      </div>
      <div class="summary-card total-withdrawals">
        <div class="card-icon">
          <i class="fas fa-money-bill-wave"></i>
        </div>
        <div class="card-content">
          <h3>Total de Retiros</h3>
          <p class="amount">{{ totalWithdrawals | currency:'USD' }}</p>
          <p class="detail">{{ withdrawals.length }} retiros</p>
        </div>
      </div>
      <div class="summary-card available-cash">
        <div class="card-icon">
          <i class="fas fa-wallet"></i>
        </div>
        <div class="card-content">
          <h3>Disponible en Caja</h3>
          <p class="amount">{{ netAvailable | currency:'USD' }}</p>
          <p class="detail">Total neto</p>
        </div>
      </div>
    </div>

    <!-- Availability by Method -->
    <section class="availability-section" *ngIf="availabilityCards.length">
      <header>
        <div>
          <p class="eyebrow">Detalle por método</p>
          <h3>Disponibilidad por medio de pago</h3>
        </div>
        <div class="filter-select">
          <label for="historyFilter">Filtrar historiales</label>
          <select id="historyFilter" [(ngModel)]="historyFilter" (ngModelChange)="onHistoryFilterChange($event)">
            <option value="all">Todos los métodos</option>
            <option *ngFor="let method of paymentMethods" [value]="method.code">
              {{ method.name }}
            </option>
          </select>
        </div>
      </header>
      <div class="availability-grid">
        <article class="availability-card"
                 *ngFor="let card of availabilityCards"
                 [class.active-filter]="historyFilter === card.code">
          <div class="availability-card__header">
            <span class="method-name">{{ card.name }}</span>
            <small>{{ card.code | uppercase }}</small>
          </div>
          <p class="availability-amount">{{ card.available | currency:'USD' }}</p>
          <div class="availability-meta">
            <span>{{ card.sales }} ventas</span>
            <span>{{ card.percentage | number:'1.0-1' }}% del total</span>
          </div>
          <button type="button"
                  class="availability-filter"
                  (click)="onHistoryFilterChange(historyFilter === card.code ? 'all' : card.code)">
            {{ historyFilter === card.code ? 'Quitar filtro' : 'Ver historial' }}
          </button>
        </article>
      </div>
    </section>

    <!-- Payment Methods Table -->
    <div class="table-container">
      <table class="payment-methods-table">
        <thead>
          <tr>
            <th>Método de Pago</th>
            <th>Ventas</th>
            <th>Total Ventas</th>
            <th>Total Retiros</th>
            <th>Total Ingresos</th>
            <th>Disponible</th>
            <th>Promedio</th>
            <th>% del Total</th>
            <th>Primera Venta</th>
            <th>Última Venta</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let method of paymentTotals">
            <td class="method-name">{{ method.payment_method_name }}</td>
            <td>{{ method.number_of_sales }}</td>
            <td class="amount positive-amount">{{ method.total_amount | currency:'USD' }}</td>
            <td class="amount negative-amount">{{ method.total_withdrawals | currency:'USD' }}</td>
            <td class="amount positive-amount">{{ method.total_incomes | currency:'USD' }}</td>
            <td class="amount">{{ method.available_amount | currency:'USD' }}</td>
            <td class="amount">{{ method.average_sale_amount | currency:'USD' }}</td>
            <td>
              <div class="percentage-bar">
                <div class="bar" [style.width.%]="getPercentage(method.total_amount)"></div>
                <span class="percentage">{{ getPercentage(method.total_amount) | number:'1.1-1' }}%</span>
              </div>
            </td>
            <td class="date-column">{{ method.first_sale | date:'MMM d, y, h:mm a' }}</td>
            <td class="date-column">{{ method.last_sale | date:'MMM d, y, h:mm a' }}</td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <td><strong>Total</strong></td>
            <td><strong>{{ totalSales }}</strong></td>
            <td class="amount"><strong>{{ totalAmount | currency:'USD' }}</strong></td>
            <td class="amount"><strong>{{ totalWithdrawals | currency:'USD' }}</strong></td>
            <td class="amount"><strong>{{ totalIncomes | currency:'USD' }}</strong></td>
            <td class="amount"><strong>{{ totalAmount - totalWithdrawals + totalIncomes | currency:'USD' }}</strong></td>
            <td colspan="4"></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Withdrawals History -->
    <div class="history-toolbar">
      <h3>Historial de movimientos</h3>
      <div class="history-filter-chips">
        <button type="button"
                class="filter-chip"
                [class.active]="historyFilter === 'all'"
                (click)="onHistoryFilterChange('all')">
          Todos
        </button>
        <button type="button"
                class="filter-chip"
                *ngFor="let method of paymentMethods"
                [class.active]="historyFilter === method.code"
                (click)="onHistoryFilterChange(method.code)">
          {{ method.name }}
        </button>
      </div>
    </div>

    <!-- Withdrawals History -->
    <div class="withdrawals-section">
      <div class="section-header">
        <h4>Retiros</h4>
        <span class="section-meta">
          {{ filteredWithdrawals.length }} registros · {{ totalWithdrawals | currency:'USD' }}
        </span>
      </div>
      <div class="table-container">
        <table class="withdrawals-table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Método de Pago</th>
              <th>Monto</th>
              <th>Descripción</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let withdrawal of filteredWithdrawals">
              <td class="date-column">{{ withdrawal.created_at | date:'MMM d, y, h:mm a' }}</td>
              <td class="method-name">{{ getPaymentMethodName(withdrawal.payment_method) }}</td>
              <td class="amount negative-amount">{{ withdrawal.amount | currency:'USD' }}</td>
              <td class="description-column">{{ withdrawal.description }}</td>
            </tr>
            <tr *ngIf="!filteredWithdrawals.length">
              <td colspan="4" class="empty-row">No hay retiros para este filtro.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Incomes History -->
    <div class="withdrawals-section">
      <div class="section-header">
        <h4>Ingresos</h4>
        <span class="section-meta">
          {{ filteredIncomes.length }} registros · {{ totalIncomes | currency:'USD' }}
        </span>
      </div>
      <div class="table-container">
        <table class="withdrawals-table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Método de Pago</th>
              <th>Monto</th>
              <th>Descripción</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let income of filteredIncomes">
              <td class="date-column">{{ income.created_at | date:'MMM d, y, h:mm a' }}</td>
              <td class="method-name">{{ getPaymentMethodName(income.payment_method) }}</td>
              <td class="amount positive-amount">{{ income.amount | currency:'USD' }}</td>
              <td class="description-column">{{ income.description }}</td>
            </tr>
            <tr *ngIf="!filteredIncomes.length">
              <td colspan="4" class="empty-row">No hay ingresos para este filtro.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Withdrawal Form Modal -->
  <div *ngIf="showWithdrawalForm" class="modal">
    <div class="modal-content">
      <h3>Registrar Retiro de Caja</h3>
      <form (ngSubmit)="registerWithdrawal()">
        <div class="form-group">
          <label for="payment_method">Método de Pago:</label>
          <select 
            id="payment_method" 
            [(ngModel)]="newWithdrawal.payment_method" 
            name="payment_method" 
            required>
            <option value="">Seleccione un método</option>
            <option *ngFor="let method of paymentMethods" [value]="method.code">
              {{ method.name }} (Disponible: {{ getAvailableAmount(method.code) | currency:'USD' }})
            </option>
          </select>
        </div>
        <div class="form-group">
          <label for="amount">Monto:</label>
          <input 
            type="number" 
            id="amount" 
            [(ngModel)]="newWithdrawal.amount" 
            name="amount" 
            [max]="newWithdrawal.payment_method ? getAvailableAmount(newWithdrawal.payment_method) : 0"
            step="0.01"
            required>
        </div>
        <div class="form-group">
          <label for="description">Descripción:</label>
          <textarea 
            id="description" 
            [(ngModel)]="newWithdrawal.description" 
            name="description" 
            required></textarea>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn-save">
            <i class="fas fa-save"></i> Registrar Retiro
          </button>
          <button type="button" (click)="showWithdrawalForm = false" class="btn-cancel">
            <i class="fas fa-times"></i> Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Income Form Modal -->
  <div *ngIf="showIncomeForm" class="modal">
    <div class="modal-content">
      <h3>Registrar Ingreso de Caja</h3>
      <form (ngSubmit)="registerIncome()">
        <div class="form-group">
          <label for="income_payment_method">Método de Pago:</label>
          <select 
            id="income_payment_method" 
            [(ngModel)]="newIncome.payment_method" 
            name="payment_method" 
            required>
            <option value="">Seleccione un método</option>
            <option *ngFor="let method of paymentMethods" [value]="method.code">
              {{ method.name }}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label for="income_amount">Monto:</label>
          <input 
            type="number" 
            id="income_amount" 
            [(ngModel)]="newIncome.amount" 
            name="amount" 
            step="0.01"
            min="0.01"
            required>
        </div>
        <div class="form-group">
          <label for="income_description">Descripción:</label>
          <textarea 
            id="income_description" 
            [(ngModel)]="newIncome.description" 
            name="description" 
            required
            placeholder="Explique el motivo del ingreso"></textarea>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn-save">
            <i class="fas fa-save"></i> Registrar Ingreso
          </button>
          <button type="button" (click)="showIncomeForm = false" class="btn-cancel">
            <i class="fas fa-times"></i> Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>